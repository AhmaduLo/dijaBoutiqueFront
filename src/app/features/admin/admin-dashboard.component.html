<div class="admin-dashboard">
  <!-- En-tête avec titre et bouton -->
  <div class="page-header">
    <h1>👑 Administration</h1>
    <button class="btn btn-primary" *ngIf="activeTab === 'users'" (click)="openForm()">+ Créer un utilisateur</button>
    <button class="btn btn-primary" *ngIf="activeTab === 'currencies'" (click)="openCurrencyForm()">+ Ajouter une devise</button>
  </div>

  <!-- Onglets de navigation -->
  <div class="tabs">
    <button
      class="tab"
      [class.active]="activeTab === 'users'"
      (click)="switchTab('users')">
      👥 Utilisateurs
    </button>
    <button
      class="tab"
      [class.active]="activeTab === 'currencies'"
      (click)="switchTab('currencies')">
      💰 Devises
    </button>
    <button
      class="tab"
      [class.active]="activeTab === 'company'"
      (click)="switchTab('company')">
      🏢 Mon Entreprise
    </button>
  </div>

  <!-- SECTION UTILISATEURS -->
  <div *ngIf="activeTab === 'users'">
    <!-- Cartes de statistiques -->
  <div class="stats-cards" *ngIf="statistiques">
    <div class="card">
      <div class="card-icon">👥</div>
      <div class="card-content">
        <h3>Total Utilisateurs</h3>
        <p class="card-value">{{ statistiques.nombreTotal }}</p>
      </div>
    </div>
    <div class="card card-admin">
      <div class="card-icon">👑</div>
      <div class="card-content">
        <h3>Administrateurs</h3>
        <p class="card-value">{{ statistiques.nombreAdmins }}</p>
      </div>
    </div>
    <div class="card card-user">
      <div class="card-icon">👤</div>
      <div class="card-content">
        <h3>Employés</h3>
        <p class="card-value">{{ statistiques.nombreUsers }}</p>
      </div>
    </div>
    <div class="card card-new">
      <div class="card-icon">✨</div>
      <div class="card-content">
        <h3>Nouveaux (7j)</h3>
        <p class="card-value">{{ statistiques.nouveauxUtilisateurs7Jours }}</p>
      </div>
    </div>
  </div>

  <!-- Formulaire modal -->
  <div class="modal" *ngIf="showForm" (click)="closeForm()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>{{ isEditing ? 'Modifier' : 'Créer' }} un utilisateur</h2>
        <button class="close-btn" (click)="closeForm()">×</button>
      </div>
      <form [formGroup]="userForm" (ngSubmit)="onSubmit()">
        <div class="form-row">
          <div class="form-group">
            <label>Nom *</label>
            <input type="text" formControlName="nom" placeholder="Ex: Diop" />
            <div class="error" *ngIf="userForm.get('nom')?.invalid && userForm.get('nom')?.touched">
              Le nom est requis
            </div>
          </div>
          <div class="form-group">
            <label>Prénom *</label>
            <input type="text" formControlName="prenom" placeholder="Ex: Mamadou" />
            <div class="error" *ngIf="userForm.get('prenom')?.invalid && userForm.get('prenom')?.touched">
              Le prénom est requis
            </div>
          </div>
        </div>

        <div class="form-group">
          <label>Email *</label>
          <input type="email" formControlName="email" placeholder="Ex: mamadou@dijaboutique.com" />
          <div class="error" *ngIf="userForm.get('email')?.invalid && userForm.get('email')?.touched">
            Email valide requis
          </div>
        </div>

        <div class="form-group">
          <label>Numéro de téléphone</label>
          <input type="tel" formControlName="numeroTelephone" placeholder="Ex: +221 77 123 45 67" />
        </div>

        <div class="form-group">
          <label>Mot de passe {{ isEditing ? '(laisser vide si inchangé)' : '*' }}</label>
          <div class="password-input">
            <input
              [type]="showPassword ? 'text' : 'password'"
              formControlName="motDePasse"
              placeholder="Minimum 6 caractères" />
            <button type="button" class="btn-icon" (click)="showPassword = !showPassword" title="Afficher/Masquer">
              {{ showPassword ? '👁️' : '👁️‍🗨️' }}
            </button>
            <button type="button" class="btn btn-secondary" (click)="generatePassword()" title="Générer un mot de passe">
              🎲 Générer
            </button>
          </div>
          <div class="error" *ngIf="userForm.get('motDePasse')?.invalid && userForm.get('motDePasse')?.touched">
            Mot de passe requis (min. 6 caractères)
          </div>
        </div>

        <div class="form-group">
          <label>Rôle *</label>
          <select formControlName="role">
            <option [value]="userRoles.USER">👤 Employé</option>
            <option [value]="userRoles.ADMIN">👑 Administrateur</option>
          </select>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-secondary" (click)="closeForm()">Annuler</button>
          <button type="submit" class="btn btn-primary" [disabled]="userForm.invalid || isSubmitting">
            {{ isSubmitting ? 'Enregistrement...' : (isEditing ? 'Modifier' : 'Créer') }}
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Filtres de recherche -->
  <div class="filters">
    <input
      type="text"
      placeholder="🔍 Rechercher par nom, prénom ou email..."
      [(ngModel)]="searchTerm"
      (input)="filterUtilisateurs()"
      [ngModelOptions]="{standalone: true}" />
    <select [(ngModel)]="selectedRole" (change)="filterUtilisateurs()" [ngModelOptions]="{standalone: true}">
      <option value="">Tous les rôles</option>
      <option [value]="userRoles.ADMIN">👑 Administrateurs</option>
      <option [value]="userRoles.USER">👤 Employés</option>
    </select>
  </div>

  <!-- Chargement -->
  <div class="loading" *ngIf="isLoading">
    <div class="spinner"></div>
    <p>Chargement des utilisateurs...</p>
  </div>

  <!-- Tableau des utilisateurs -->
  <div class="users-table" *ngIf="!isLoading">
    <table *ngIf="filteredUtilisateurs.length > 0">
      <thead>
        <tr>
          <th>Utilisateur</th>
          <th>Email</th>
          <th>Entreprise</th>
          <th>Téléphone</th>
          <th>Rôle</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let user of filteredUtilisateurs">
          <td>
            <div class="user-cell">
              <strong>{{ user.prenom }} {{ user.nom }}</strong>
              <span class="badge-you" *ngIf="user.id === currentUser?.id">Vous</span>
            </div>
          </td>
          <td>{{ user.email }}</td>
          <td>
            <span class="text-muted" *ngIf="!user.nomEntreprise">-</span>
            <span *ngIf="user.nomEntreprise">{{ user.nomEntreprise }}</span>
          </td>
          <td>
            <span class="text-muted" *ngIf="!user.numeroTelephone">-</span>
            <span *ngIf="user.numeroTelephone">{{ user.numeroTelephone }}</span>
          </td>
          <td>
            <span class="role-badge" [style.background-color]="getRoleColor(user.role)">
              {{ getRoleIcon(user.role) }} {{ getRoleLabel(user.role) }}
            </span>
          </td>
          <td>
            <div class="actions">
              <button
                class="btn-icon"
                (click)="changeRole(user)"
                title="Changer le rôle"
                [disabled]="user.id === currentUser?.id">
                🔄
              </button>
              <button class="btn-icon" (click)="editUser(user)" title="Modifier">✏️</button>
              <button
                class="btn-icon btn-delete"
                (click)="deleteUser(user)"
                [disabled]="user.id === currentUser?.id"
                title="Supprimer">
                🗑️
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>

    <div class="empty-state" *ngIf="filteredUtilisateurs.length === 0">
      <div class="empty-icon">👥</div>
      <h3>Aucun utilisateur trouvé</h3>
      <p *ngIf="searchTerm || selectedRole">Essayez de modifier vos filtres</p>
      <p *ngIf="!searchTerm && !selectedRole">Créez votre premier utilisateur</p>
      <button class="btn btn-primary" (click)="openForm()">+ Créer un utilisateur</button>
    </div>
  </div>
  </div>
  <!-- FIN SECTION UTILISATEURS -->

  <!-- SECTION DEVISES -->
  <div *ngIf="activeTab === 'currencies'">
    <!-- Formulaire modal des devises -->
    <div class="modal" *ngIf="showCurrencyForm" (click)="closeCurrencyForm()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>{{ isEditingCurrency ? 'Modifier' : 'Ajouter' }} une devise</h2>
          <button class="close-btn" (click)="closeCurrencyForm()">×</button>
        </div>
        <form [formGroup]="currencyForm" (ngSubmit)="onSubmitCurrency()">
          <!-- Devises prédéfinies -->
          <div class="predefined-currencies" *ngIf="!isEditingCurrency">
            <label>Devises courantes :</label>
            <div class="currency-buttons">
              <button
                type="button"
                class="btn btn-secondary btn-sm"
                *ngFor="let devise of devisesCommunes"
                (click)="addPredefinedCurrency(devise)">
                {{ devise.symbole }} {{ devise.code }} - {{ devise.pays }}
              </button>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Code devise * (ex: USD, EUR, XOF)</label>
              <input type="text" formControlName="code" placeholder="Ex: XOF" style="text-transform: uppercase" />
              <div class="error" *ngIf="currencyForm.get('code')?.invalid && currencyForm.get('code')?.touched">
                Le code est requis
              </div>
            </div>
            <div class="form-group">
              <label>Symbole * (ex: $, €, CFA)</label>
              <input type="text" formControlName="symbole" placeholder="Ex: CFA" />
              <div class="error" *ngIf="currencyForm.get('symbole')?.invalid && currencyForm.get('symbole')?.touched">
                Le symbole est requis
              </div>
            </div>
          </div>

          <div class="form-group">
            <label>Nom complet *</label>
            <input type="text" formControlName="nom" placeholder="Ex: Franc CFA" />
            <div class="error" *ngIf="currencyForm.get('nom')?.invalid && currencyForm.get('nom')?.touched">
              Le nom est requis
            </div>
          </div>

          <div class="form-group">
            <label>Pays *</label>
            <input type="text" formControlName="pays" placeholder="Ex: Sénégal" />
            <div class="error" *ngIf="currencyForm.get('pays')?.invalid && currencyForm.get('pays')?.touched">
              Le pays est requis
            </div>
          </div>

          <div class="form-group">
            <label>Taux de change * (par rapport à la devise de référence)</label>
            <input type="number" step="0.001" formControlName="tauxChange" placeholder="Ex: 1" />
            <div class="error" *ngIf="currencyForm.get('tauxChange')?.invalid && currencyForm.get('tauxChange')?.touched">
              Le taux de change est requis
            </div>
            <small class="info-text">1 unité de devise de référence = X unités de cette devise</small>
          </div>

          <div class="form-group">
            <label class="checkbox-label">
              <input type="checkbox" formControlName="isDefault" />
              Définir comme devise par défaut du système
            </label>
          </div>

          <div class="form-actions">
            <button type="button" class="btn btn-secondary" (click)="closeCurrencyForm()">Annuler</button>
            <button type="submit" class="btn btn-primary" [disabled]="currencyForm.invalid || isSubmitting">
              {{ isSubmitting ? 'Enregistrement...' : (isEditingCurrency ? 'Modifier' : 'Ajouter') }}
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Filtres de recherche des devises -->
    <div class="filters">
      <input
        type="text"
        placeholder="🔍 Rechercher par code, nom, pays ou symbole..."
        [(ngModel)]="searchCurrency"
        (input)="filterCurrencies()"
        [ngModelOptions]="{standalone: true}" />
    </div>

    <!-- Chargement -->
    <div class="loading" *ngIf="isLoading">
      <div class="spinner"></div>
      <p>Chargement des devises...</p>
    </div>

    <!-- Tableau des devises -->
    <div class="currencies-table" *ngIf="!isLoading">
      <table *ngIf="filteredCurrencies.length > 0">
        <thead>
          <tr>
            <th>Code</th>
            <th>Nom</th>
            <th>Symbole</th>
            <th>Pays</th>
            <th>Taux de change</th>
            <th>Par défaut</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let currency of filteredCurrencies" [class.default-row]="currency.isDefault">
            <td><strong>{{ currency.code }}</strong></td>
            <td>{{ currency.nom }}</td>
            <td><span class="currency-symbol">{{ currency.symbole }}</span></td>
            <td>{{ currency.pays }}</td>
            <td>{{ currency.tauxChange || 'N/A' }}</td>
            <td>
              <span class="badge" [class.badge-success]="currency.isDefault" [class.badge-secondary]="!currency.isDefault">
                {{ currency.isDefault ? '✓ Oui' : 'Non' }}
              </span>
            </td>
            <td>
              <div class="actions">
                <button
                  class="btn-icon"
                  (click)="setDefaultCurrency(currency)"
                  title="Définir par défaut"
                  [disabled]="currency.isDefault">
                  ⭐
                </button>
                <button class="btn-icon" (click)="editCurrency(currency)" title="Modifier">✏️</button>
                <button
                  class="btn-icon btn-delete"
                  (click)="deleteCurrency(currency)"
                  [disabled]="currency.isDefault"
                  title="Supprimer">
                  🗑️
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>

      <div class="empty-state" *ngIf="filteredCurrencies.length === 0">
        <div class="empty-icon">💰</div>
        <h3>Aucune devise trouvée</h3>
        <p *ngIf="searchCurrency">Essayez de modifier vos filtres</p>
        <p *ngIf="!searchCurrency">Ajoutez votre première devise</p>
        <button class="btn btn-primary" (click)="openCurrencyForm()">+ Ajouter une devise</button>
      </div>
    </div>
  </div>
  <!-- FIN SECTION DEVISES -->

  <!-- SECTION MON ENTREPRISE -->
  <div *ngIf="activeTab === 'company'">
    <!-- Chargement -->
    <div class="loading" *ngIf="isLoadingTenant">
      <div class="spinner"></div>
      <p>Chargement des informations de l'entreprise...</p>
    </div>

    <!-- Informations de l'entreprise -->
    <div class="company-section" *ngIf="!isLoadingTenant && tenant" style="max-width: 800px; margin: 0 auto; padding: 2rem;">
      <div class="company-card" style="background: white; border-radius: 16px; padding: 2.5rem; box-shadow: 0 4px 16px rgba(0,0,0,0.1);">
        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; padding-bottom: 1.5rem; border-bottom: 3px solid #f3f4f6;">
          <h2 style="margin: 0; font-size: 1.75rem; color: #1f2937; font-weight: 700;">🏢 Informations de l'entreprise</h2>
          <button class="btn btn-primary" *ngIf="!isEditingTenant" (click)="startEditingTenant()" style="background: #e91e63; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer;">
            ✏️ Modifier
          </button>
        </div>

        <!-- Mode lecture -->
        <div class="company-info" *ngIf="!isEditingTenant" style="display: grid; gap: 2rem;">
          <div class="info-row" style="display: flex; flex-direction: column;">
            <label style="font-weight: 600; color: #6b7280; margin-bottom: 0.75rem; font-size: 0.875rem; text-transform: uppercase;">Nom de l'entreprise :</label>
            <p style="margin: 0; font-size: 1.25rem; color: #1f2937; padding: 1rem 1.25rem; background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%); border-radius: 10px; border-left: 4px solid #e91e63; font-weight: 500;">{{ tenant.nomEntreprise }}</p>
          </div>
          <div class="info-row" style="display: flex; flex-direction: column;">
            <label style="font-weight: 600; color: #6b7280; margin-bottom: 0.75rem; font-size: 0.875rem; text-transform: uppercase;">Numéro de téléphone :</label>
            <p style="margin: 0; font-size: 1.25rem; color: #1f2937; padding: 1rem 1.25rem; background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%); border-radius: 10px; border-left: 4px solid #e91e63; font-weight: 500;">{{ tenant.numeroTelephone }}</p>
          </div>
          <div class="info-row" style="display: flex; flex-direction: column;">
            <label style="font-weight: 600; color: #6b7280; margin-bottom: 0.75rem; font-size: 0.875rem; text-transform: uppercase;">Identifiant unique (UUID) :</label>
            <p class="uuid" style="margin: 0; font-family: 'Courier New', monospace; font-size: 0.95rem; color: #6b7280; padding: 1rem 1.25rem; background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%); border-radius: 10px; border-left: 4px solid #3b82f6; word-break: break-all;">{{ tenant.tenantUuid }}</p>
          </div>
        </div>

        <!-- Mode édition -->
        <form [formGroup]="tenantForm" (ngSubmit)="onSubmitTenant()" *ngIf="isEditingTenant">
          <div class="form-group" style="margin-bottom: 1.5rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151; font-size: 0.95rem;">Nom de l'entreprise *</label>
            <input type="text" formControlName="nomEntreprise" placeholder="Ex: Boutique Dija" style="width: 100%; padding: 0.875rem 1rem; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 1rem; font-family: inherit;" />
            <div class="error" *ngIf="tenantForm.get('nomEntreprise')?.invalid && tenantForm.get('nomEntreprise')?.touched" style="color: #dc2626; font-size: 0.875rem; margin-top: 0.5rem;">
              Le nom de l'entreprise est requis
            </div>
          </div>

          <div class="form-group" style="margin-bottom: 1.5rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151; font-size: 0.95rem;">Numéro de téléphone *</label>
            <input type="tel" formControlName="numeroTelephone" placeholder="Ex: +221 77 123 45 67" style="width: 100%; padding: 0.875rem 1rem; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 1rem; font-family: inherit;" />
            <div class="error" *ngIf="tenantForm.get('numeroTelephone')?.invalid && tenantForm.get('numeroTelephone')?.touched" style="color: #dc2626; font-size: 0.875rem; margin-top: 0.5rem;">
              Le numéro de téléphone est requis
            </div>
          </div>

          <div class="form-actions" style="display: flex; gap: 1rem; margin-top: 2rem; padding-top: 1.5rem; border-top: 2px solid #f3f4f6;">
            <button type="button" class="btn btn-secondary" (click)="cancelEditingTenant()" style="flex: 1; padding: 0.875rem 1.5rem; border-radius: 8px; font-weight: 600; font-size: 1rem; cursor: pointer; background: #f3f4f6; color: #6b7280; border: 2px solid #e5e7eb;">
              Annuler
            </button>
            <button type="submit" class="btn btn-primary" [disabled]="tenantForm.invalid || isSubmitting" style="flex: 1; padding: 0.875rem 1.5rem; border-radius: 8px; font-weight: 600; font-size: 1rem; cursor: pointer; background: #e91e63; color: white; border: none;" [style.opacity]="(tenantForm.invalid || isSubmitting) ? '0.5' : '1'" [style.cursor]="(tenantForm.invalid || isSubmitting) ? 'not-allowed' : 'pointer'">
              {{ isSubmitting ? 'Enregistrement...' : 'Enregistrer' }}
            </button>
          </div>
        </form>

        <div class="info-message" style="margin-top: 2.5rem; padding: 1.25rem; background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border-left: 4px solid #3b82f6; border-radius: 10px;">
          <p style="margin: 0.5rem 0; color: #1e40af; font-size: 0.9rem; line-height: 1.6;"><strong style="display: block; margin-bottom: 0.5rem; font-size: 1rem;">ℹ️ Note importante :</strong></p>
          <p style="margin: 0.5rem 0; color: #1e40af; font-size: 0.9rem; line-height: 1.6;">La modification du nom de l'entreprise met à jour automatiquement l'information pour tous les utilisateurs de votre entreprise.</p>
        </div>
      </div>
    </div>
  </div>
  <!-- FIN SECTION MON ENTREPRISE -->
</div>
